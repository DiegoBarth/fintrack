import{T as e,i as t,n,t as r,w as i}from"./react-query-B5bzpzJa.js";import{i as a,n as o,r as s,t as c}from"./index-CUHawgsg.js";import{a as l,c as u,i as d,n as f,o as p}from"./formatters-DVAU20Gu.js";function m(e,t){let{data:r=null,isLoading:i,isError:a}=n({queryKey:[`summary`,e,t],queryFn:()=>c(e,String(t))});return{summary:r,isLoading:i,isError:a}}function h(e){return e.trim().replace(/\s+/g,` `).replace(/[\u0000-\u001F\u007F]/g,``)}function g(e){return s({action:`createIncome`,...e,description:h(e.description)})}function _(e,t){return o({action:`listIncomes`,month:e,year:t})}function v(e,t){return s({action:`deleteIncome`,rowIndex:e,scope:t||`single`})}async function y(e){let t=await s({action:`updateIncome`,...e});return e.receivedDate=e.receivedDate?d(e.receivedDate):``,t}function b(){let e=a();return{handleError:t=>{try{if(t instanceof TypeError&&t.message.includes(`fetch`)){e.error(`Erro de conexão com o servidor`);return}if(t instanceof Error){let n=t.message;try{let t=JSON.parse(n);e.error(t.message||`Erro ao processar requisição`);return}catch{if(n.includes(`401`)||n.includes(`Unauthorized`)){e.error(`Sessão expirada. Faça login novamente`);return}if(n.includes(`403`)||n.includes(`Forbidden`)){e.error(`Você não tem permissão para realizar esta ação`);return}if(n.includes(`404`)||n.includes(`Not Found`)){e.error(`Recurso não encontrado`);return}if(n.includes(`500`)||n.includes(`Internal`)){e.error(`Erro no servidor. Tente novamente mais tarde`);return}e.error(n||`Erro desconhecido`);return}}let n=String(t);e.error(n||`Erro ao processar a requisição. Tente novamente`)}catch(t){console.error(`Erro ao processar erro:`,t),e.error(`Erro desconhecido`)}}}}function x(e){e.invalidateQueries({queryKey:[`summary`],exact:!1}),e.invalidateQueries({queryKey:[`dashboard`],exact:!1})}function S(e,t,n){e.setQueryData([`incomes`,n],e=>(e?[...e,t]:[t]).sort((e,t)=>{let n=new Date(f(e.expectedDate)),r=new Date(f(t.expectedDate));return n.getTime()===r.getTime()?e.description.localeCompare(t.description):n.getTime()-r.getTime()})),x(e)}function C(e,t,n,r){e.setQueryData([`incomes`,r],e=>e?.map(e=>e.rowIndex===t.rowIndex?{...e,...n}:e)??[]),x(e)}function w(e,t,n){e.setQueryData([`incomes`,n],e=>{if(!e)return[];let n=new Set(t.map(e=>e.rowIndex));return e.filter(e=>!n.has(e.rowIndex)).map(e=>{let n=t.filter(t=>t.rowIndex<e.rowIndex).length;return{...e,rowIndex:e.rowIndex-n}}).sort((e,t)=>{let n=new Date(f(e.expectedDate)),r=new Date(f(t.expectedDate));return n.getTime()===r.getTime()?e.description.localeCompare(t.description):n.getTime()-r.getTime()})}),x(e)}function T(e,i){let a=t(),{handleError:o}=b(),{data:s=[],isLoading:c,isError:l}=n({queryKey:[`incomes`,i],queryFn:()=>_(`all`,String(i)),staleTime:1/0,retry:1}),d=e===`all`?s:s.filter(t=>{let{month:n}=p(t.referenceMonth);return String(n)===String(e)}),m=r({mutationFn:e=>g(e),onSuccess:e=>{e.forEach(e=>{let{year:t}=p(e.referenceMonth);S(a,e,t)})},onError:o}),h=r({mutationFn:e=>y(e),onSuccess:e=>{e.forEach(e=>{let{year:t}=p(e.referenceMonth),n=a.getQueryData([`incomes`,t])?.find(t=>t.rowIndex===e.rowIndex);n&&C(a,n,e,t)})},onError:o}),x=r({mutationFn:e=>typeof e==`number`?v(e):v(e.rowIndex,e.scope),onSuccess:(e,t)=>{let n=typeof t==`number`?t:t.rowIndex,r=typeof t==`number`?`single`:t.scope,i=s.find(e=>e.rowIndex===n);if(!i)return;let o=r===`future`?(()=>{let e=new Date(u(f(i.expectedDate)));return s.filter(t=>t.description===i.description&&new Date(u(f(t.expectedDate)))>=e)})():[i],c=new Map;o.forEach(e=>{let{year:t}=p(e.referenceMonth),n=c.get(t)??[];n.push(e),c.set(t,n)}),c.forEach((e,t)=>{w(a,e,t)})},onError:o});return{incomes:d,isLoading:c,isError:l,create:m.mutateAsync,update:h.mutateAsync,remove:x.mutateAsync,isSaving:m.isPending||h.isPending,isDeleting:x.isPending}}function E(e){return s({action:`createExpense`,...e,description:h(e.description),category:h(e.category)})}function D(e,t){return o({action:`listExpenses`,month:e,year:t})}function O(e){return s({action:`deleteExpense`,rowIndex:e})}function k(e){return s({action:`updateExpense`,...e})}function A(e,t,n){e.setQueryData([`expenses`,n],e=>(e?[...e,t]:[t]).sort((e,t)=>{let n=new Date(f(e.paymentDate)),r=new Date(f(t.paymentDate));return n.getTime()===r.getTime()?e.description.localeCompare(t.description):n.getTime()-r.getTime()})),x(e)}function j(e,t,n,r){e.setQueryData([`expenses`,r],e=>e?.map(e=>e.rowIndex===t.rowIndex?{...e,...n}:e)??[]),x(e)}function M(e,t,n){let r=t.rowIndex;e.setQueryData([`expenses`,n],e=>e?e.filter(e=>e.rowIndex!==r).map(e=>({...e,rowIndex:e.rowIndex>r?e.rowIndex-1:e.rowIndex})).sort((e,t)=>{let n=new Date(f(e.paymentDate)),r=new Date(f(t.paymentDate));return n.getTime()===r.getTime()?e.description.localeCompare(t.description):n.getTime()-r.getTime()}):[]),x(e)}function N(e,i){let a=t(),{handleError:o}=b(),{data:s=[],isLoading:c,isError:u}=n({queryKey:[`expenses`,i],queryFn:()=>D(`all`,String(i)),staleTime:1/0,retry:1}),d=e===`all`?s:s.filter(t=>{let{month:n}=l(t.paymentDate);return String(n)===String(e)}),f=r({mutationFn:e=>E(e),onSuccess:e=>{let{year:t}=l(e.paymentDate);A(a,e,t)},onError:o}),p=r({mutationFn:e=>k(e),onSuccess:e=>{let{year:t}=l(e.paymentDate),n=a.getQueryData([`expenses`,t])?.find(t=>t.rowIndex===e.rowIndex);n&&j(a,n,e,t)},onError:o}),m=r({mutationFn:e=>O(e),onSuccess:(e,t)=>{let n=s.find(e=>e.rowIndex===t);if(n){let{year:e}=l(n.paymentDate);M(a,n,e)}},onError:o});return{expenses:d,isLoading:c,isError:u,create:f.mutateAsync,update:p.mutateAsync,remove:m.mutateAsync,isSaving:f.isPending||p.isPending,isDeleting:m.isPending}}function P(e,t){return o({action:`listCommitments`,month:e,year:t})}function F(e){return s({action:`createCommitment`,...e,description:h(e.description),category:h(e.category),type:h(e.type)})}function I(e){return s({action:`createCard`,...e,description:h(e.description),category:h(e.category),card:e.card?h(e.card):void 0,type:h(e.type)})}function L(e,t=`single`){return s({action:`deleteCommitment`,rowIndex:e,scope:t})}async function R(e){let t=await s({action:`updateCommitment`,...e});return e.paymentDate=e.paymentDate?d(e.paymentDate):``,t}function z(e){return s({action:`payCardStatement`,rowIndexes:e.rowIndexes,paymentDate:e.paymentDate})}function B(e,t,n){e.setQueryData([`commitments`,n],e=>(e?[...e,t]:[t]).sort((e,t)=>{let n=new Date(f(e.dueDate)),r=new Date(f(t.dueDate));return n.getTime()===r.getTime()?e.description.localeCompare(t.description):n.getTime()-r.getTime()})),x(e)}function V(e,t,n,r){e.setQueryData([`commitments`,r],e=>e?.map(e=>e.rowIndex===t.rowIndex?{...e,...n}:e)??[]),x(e)}function H(e,t,n){e.setQueryData([`commitments`,n],e=>{if(!e)return[];let n=new Set(t.map(e=>e.rowIndex));return e.filter(e=>!n.has(e.rowIndex)).map(e=>{let n=t.filter(t=>t.rowIndex<e.rowIndex).length;return{...e,rowIndex:e.rowIndex-n}}).sort((e,t)=>{let n=new Date(f(e.dueDate)),r=new Date(f(t.dueDate));return n.getTime()===r.getTime()?e.description.localeCompare(t.description):n.getTime()-r.getTime()})}),x(e)}function U(e,i){let a=t(),{handleError:o}=b(),{data:s=[],isLoading:c,isError:l}=n({queryKey:[`commitments`,i],queryFn:()=>P(`all`,String(i)),staleTime:1/0,retry:1}),u=e===`all`?s:s.filter(t=>{let{month:n}=p(t.referenceMonth);return String(n)===String(e)}),d=s,f=r({mutationFn:F,onSuccess:e=>{e.forEach(e=>{let{year:t}=p(e.referenceMonth);B(a,e,t)})},onError:o}),m=r({mutationFn:I,onSuccess:e=>{e.forEach(e=>{let{year:t}=p(e.referenceMonth);B(a,e,t)})},onError:o}),h=r({mutationFn:R,onSuccess:e=>{e.forEach(e=>{let{year:t}=p(e.referenceMonth),n=a.getQueryData([`commitments`,t])?.find(t=>t.rowIndex===e.rowIndex);n&&V(a,n,e,t)})},onError:o}),g=r({mutationFn:z,onSuccess:e=>{e.forEach(e=>{let{year:t}=p(e.referenceMonth),n=a.getQueryData([`commitments`,t])?.find(t=>t.rowIndex===e.rowIndex);n&&V(a,n,e,t)})},onError:o}),_=r({mutationFn:e=>typeof e==`number`?L(e):L(e.rowIndex,e.scope),onSuccess:e=>{if(!e?.length)return;let t=new Map;e.forEach(e=>{let{year:n}=p(e.referenceMonth),r=t.get(n)??[];r.push(e),t.set(n,r)}),t.forEach((e,t)=>{H(a,e,t)})},onError:o});return{commitments:u,alertCommitments:d,isLoading:c,isError:l,create:f.mutateAsync,createCard:m.mutateAsync,update:h.mutateAsync,payCardStatement:g.mutateAsync,remove:_.mutateAsync,isSaving:f.isPending||m.isPending||h.isPending||g.isPending,isDeleting:_.isPending}}function W(e,t){return o({action:`listDashboardData`,month:e,year:t})}function G(e,t){let{data:r,isLoading:i,isError:a}=n({queryKey:[`dashboard`,e,t],queryFn:()=>W(e,String(t)),staleTime:1/0});return{dashboard:r??{monthlyBalance:[],topCategories:[],cardsSummary:[]},isLoading:i,isError:a}}var K=e(),q=i();const J=(0,K.createContext)({month:String(new Date().getMonth()+1),setMonth:()=>{},year:new Date().getFullYear(),setYear:()=>{},summary:null,incomes:null,expenses:null,commitments:null,alertCommitments:null,dashboard:{monthlyBalance:[],topCategories:[],cardsSummary:[]},isLoading:!1});function Y(){let e=sessionStorage.getItem(`period`);if(e)return JSON.parse(e);let t=new Date;return{month:String(t.getMonth()+1),year:t.getFullYear()}}function X({children:e}){let t=Y(),[n,r]=(0,K.useState)(t.month),[i,a]=(0,K.useState)(t.year),{summary:o,isLoading:s}=m(n,String(i)),{incomes:c}=T(n,String(i)),{expenses:l}=N(n,String(i)),{commitments:u,alertCommitments:d}=U(n,String(i)),{dashboard:f}=G(n,String(i));return(0,K.useEffect)(()=>{sessionStorage.setItem(`period`,JSON.stringify({month:n,year:i}))},[n,i]),(0,q.jsx)(J.Provider,{value:{month:n,setMonth:r,year:i,setYear:a,summary:o,incomes:c,expenses:l,commitments:u,alertCommitments:d,dashboard:f,isLoading:s},children:e})}const Z=()=>(0,K.useContext)(J);export{N as a,U as i,Z as n,T as o,G as r,X as t};